<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stacked Bar Chart with Agency Selector</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
        }
        canvas {
            border: 1px solid #000;
        }

        #update-time {
            margin-top: 20px;
            font-size: 14px;
        }

        .axis text {
            font-size: 12px;
        }

        .axis path,
        .axis line {
            fill: none;
            shape-rendering: crispEdges;
        }

        #csv-file {
            margin: 20px 0;
        }

        /* Set the chart container height */
        #chart {
            height: 1200px; /* Increased height */
            width: 100%;
        }
    </style>
</head>
<body>

    <h1>Word Count Stacked Bar Chart per Agency</h1>

    <!-- Dropdown for selecting agency -->
    <label for="agency-select">Select Agency:</label>
    <select id="agency-select">
        <option value="All">All Agencies</option> <!-- Option to show all agencies -->
    </select>

    <div id="chart"></div>

    <script src="https://d3js.org/d3.v6.min.js"></script>
    <script>
        // Initialize the raw data variable
        let rawData = [];

        // Automatically fetch the CSV file from the server
        d3.csv("word_counts.csv").then(function(csvData) {
            rawData = csvData;

            // Populate dropdown with agencies that have data
            populateDropdown(rawData);

            // Update the chart with data for all agencies (default)
            updateChart('All');
        }).catch(function(error) {
            console.error('Error loading CSV:', error);
        });

        // Populate the dropdown menu with agency names, but only agencies with data
        function populateDropdown(data) {
            const agencySelect = document.getElementById('agency-select');
            
            // Filter out agencies that have no associated data
            const agenciesWithData = Array.from(new Set(data.map(d => d.Agency)))
                .filter(agency => {
                    // Check if the agency has any corresponding chapters with data
                    return data.some(d => d.Agency === agency && d["Word Count"] && d["Word Count"] > 0);
                });

            // Add filtered agencies to the dropdown
            agenciesWithData.forEach(agency => {
                const option = document.createElement('option');
                option.value = agency;
                option.textContent = agency;
                agencySelect.appendChild(option);
            });

            // Add event listener for dropdown selection
            agencySelect.addEventListener('change', function() {
                const selectedAgency = agencySelect.value;
                updateChart(selectedAgency);
            });
        }

        // Function to update chart based on selected agency
        function updateChart(selectedAgency) {
            let filteredData;
            if (selectedAgency === 'All') {
                filteredData = rawData;
            } else {
                filteredData = rawData.filter(d => d.Agency === selectedAgency);
            }

            // Process the data for the chart
            const chapters = Array.from(new Set(filteredData.map(d => d.Chapter)));

            // Sort chapters (Roman numerals first, then numbers)
            const sortedChapters = sortChapters(chapters);

            // Now correctly filter and map the data according to sorted chapters
            const data = sortedChapters.map(chapter => {
                const chapterData = filteredData.filter(d => d.Chapter === chapter);
                return {
                    x: chapterData.map(d => d.Agency),
                    y: chapterData.map(d => +d["Word Count"]),
                    name: chapter,
                    type: 'bar',
                    marker: { color: getChapterColor(sortedChapters.indexOf(chapter), sortedChapters.length) }, // Set color per chapter
                    showlegend: true
                };
            });

            const layout = {
                barmode: 'stack', // Stacked bars
                title: selectedAgency === 'All' ? 'Word Count per Agency and Chapter (All Agencies)' : `Word Count for ${selectedAgency}`,
                xaxis: {
                    title: 'Agency',
                    automargin: true // Ensure thereâ€™s margin around x-axis labels
                },
                yaxis: {
                    title: 'Word Count',
                    automargin: true // Add margin for Y-axis
                },
                margin: {
                    t: 50, // top margin for title
                    b: 100, // bottom margin to avoid overlap with x-axis labels
                    l: 50, // left margin for y-axis labels
                    r: 50  // right margin
                },
                legend: {
                    title: { text: 'Chapters' }, // Title for the legend
                    x: 1.05, // Adjust position of the legend
                    y: 1,
                    traceorder: 'normal',
                    orientation: 'v', // vertical orientation for legend
                    itemclick: 'toggleothers'
                }
            };

            // Plot the chart with filtered data
            Plotly.newPlot('chart', data, layout);
        }

        // Function to sort chapters (Roman numerals first, then numbers)
        function sortChapters(chapters) {
            const romanNumerals = ['I', 'II', 'III', 'IV', 'V', 'VI', 'VII', 'VIII', 'IX', 'X', 'XI', 'XII']; // Add more if needed

            const roman = chapters.filter(chapter => romanNumerals.includes(chapter));
            const numbers = chapters.filter(chapter => !isNaN(chapter));
            
            return [...roman, ...numbers.sort((a, b) => a - b)]; // Roman numerals first, then sorted numbers
        }

        // Function to generate a color for each chapter based on its index
        function getChapterColor(index, totalChapters) {
            // Generate distinct colors based on the number of chapters
            const hue = (index / totalChapters) * 360; // Spread colors evenly across the hue spectrum
            const saturation = 70; // Saturation level (70% for a vibrant color)
            const lightness = 50;  // Lightness level (50% for neutral colors)

            return `hsl(${hue}, ${saturation}%, ${lightness}%)`; // Generate color in HSL format
        }
    </script>

</body>
</html>
